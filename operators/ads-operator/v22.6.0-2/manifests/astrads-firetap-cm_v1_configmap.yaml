# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2021-2022 Intel Corporation

apiVersion: v1
data:
  config.json: |
    {
        "ociVersion": "1.0.1-dev",
        "process": {
          "user": {
            "uid": 0,
            "gid": 0
          },
          "args": [
            "/usr/bin/supervisord",
            "--config",
            "/sf/etc/element-supervisord.conf"
          ],
          "env": [
            "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          ],
          "cwd": "/",
          "capabilities": {
            "bounding": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ],
            "effective": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ],
            "inheritable": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ],
            "permitted": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ]
          },
          "oomScoreAdj": 0
        },
        "root": {
          "path": "rootfs"
        },
        "hostname": "NHCIBAJJ0137",
        "mounts": [
          {
            "destination": "/proc",
            "type": "proc",
            "source": "proc",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/dev",
            "type": "tmpfs",
            "source": "tmpfs",
            "options": [
              "nosuid",
              "strictatime",
              "mode=755",
              "size=65536k"
            ]
          },
          {
            "destination": "/dev/pts",
            "type": "devpts",
            "source": "devpts",
            "options": [
              "nosuid",
              "noexec",
              "newinstance",
              "ptmxmode=0666",
              "mode=0620",
              "gid=5"
            ]
          },
          {
            "destination": "/sys",
            "type": "sysfs",
            "source": "sysfs",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/sys/fs/cgroup",
            "type": "cgroup",
            "source": "cgroup",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/dev/mqueue",
            "type": "mqueue",
            "source": "mqueue",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/dev/shm",
            "type": "tmpfs",
            "source": "shm",
            "options": [
              "nosuid",
              "noexec",
              "nodev",
              "mode=1777",
              "size=2147483648"
            ]
          },
          {
            "destination": "/persist",
            "type": "bind",
            "source": "/var/netapp/firetap/firegen/persist",
            "options": [
              "rbind",
              "rprivate"
            ]
          },
          {
            "destination": "/var/log",
            "type": "bind",
            "source": "/var/netapp/firetap/firegen/persist/var/log",
            "options": [
              "rbind",
              "rprivate"
            ]
          },
          {
            "destination": "/var/run/dbus",
            "type": "bind",
            "source": "/var/run/dbus",
            "options": [
              "rbind",
              "rprivate"
            ]
          },
          {
            "destination": "/etc/resolv.conf",
            "type": "bind",
            "source": "/etc/resolv.conf",
            "options": [
              "ro",
              "rbind",
              "rprivate",
              "nosuid",
              "noexec",
              "nodev"
            ]
          }
        ],
        "linux": {
          "resources": {
            "devices": [
              {
                "allow": true,
                "access": "rwm"
              }
            ],
            "memory": {
              "disableOOMKiller": false,
              "limit": 9223372036854775807
            },
            "cpu": {
              "shares": 0
            },
            "blockIO": {
              "weight": 0
            }
          },
          "cgroupsPath": "system.slice:runc:firetap",
          "namespaces": [
            {
              "type": "mount"
            },
            {
              "type": "uts"
            },
            {
              "type": "pid"
            },
            {
              "type": "ipc"
            }
          ],
          "devices": [
            {
              "path": "/dev/ipmi0",
              "type": "c",
              "major": 240,
              "minor": 0,
              "fileMode": 8576,
              "uid": 0,
              "gid": 0
            },
            {
              "path": "/dev/mem",
              "type": "c",
              "major": 1,
              "minor": 1,
              "fileMode": 8608,
              "uid": 0,
              "gid": 9
            }
          ]
        }
      }
  config_netwd.json: |
    {
        "ociVersion": "1.0.1-dev",
        "process": {
          "user": {
            "uid": 0,
            "gid": 0
          },
          "args": [
            "/usr/bin/supervisord",
            "--config",
            "/sf/etc/netwd-supervisord.conf"
          ],
          "env": [
            "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          ],
          "cwd": "/",
          "capabilities": {
            "bounding": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ],
            "effective": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ],
            "inheritable": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ],
            "permitted": [
              "CAP_CHOWN",
              "CAP_DAC_OVERRIDE",
              "CAP_DAC_READ_SEARCH",
              "CAP_FOWNER",
              "CAP_FSETID",
              "CAP_KILL",
              "CAP_SETGID",
              "CAP_SETUID",
              "CAP_SETPCAP",
              "CAP_LINUX_IMMUTABLE",
              "CAP_NET_BIND_SERVICE",
              "CAP_NET_BROADCAST",
              "CAP_NET_ADMIN",
              "CAP_NET_RAW",
              "CAP_IPC_LOCK",
              "CAP_IPC_OWNER",
              "CAP_SYS_MODULE",
              "CAP_SYS_RAWIO",
              "CAP_SYS_CHROOT",
              "CAP_SYS_PTRACE",
              "CAP_SYS_PACCT",
              "CAP_SYS_ADMIN",
              "CAP_SYS_BOOT",
              "CAP_SYS_NICE",
              "CAP_SYS_RESOURCE",
              "CAP_SYS_TIME",
              "CAP_SYS_TTY_CONFIG",
              "CAP_MKNOD",
              "CAP_LEASE",
              "CAP_AUDIT_WRITE",
              "CAP_AUDIT_CONTROL",
              "CAP_SETFCAP",
              "CAP_MAC_OVERRIDE",
              "CAP_MAC_ADMIN",
              "CAP_SYSLOG",
              "CAP_WAKE_ALARM",
              "CAP_BLOCK_SUSPEND"
            ]
          },
          "oomScoreAdj": 0
        },
        "root": {
          "path": "rootfs"
        },
        "hostname": "NHCIBAJJ0137",
        "mounts": [
          {
            "destination": "/proc",
            "type": "proc",
            "source": "proc",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/dev",
            "type": "tmpfs",
            "source": "tmpfs",
            "options": [
              "nosuid",
              "strictatime",
              "mode=755",
              "size=65536k"
            ]
          },
          {
            "destination": "/dev/pts",
            "type": "devpts",
            "source": "devpts",
            "options": [
              "nosuid",
              "noexec",
              "newinstance",
              "ptmxmode=0666",
              "mode=0620",
              "gid=5"
            ]
          },
          {
            "destination": "/sys",
            "type": "sysfs",
            "source": "sysfs",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/sys/fs/cgroup",
            "type": "cgroup",
            "source": "cgroup",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/dev/mqueue",
            "type": "mqueue",
            "source": "mqueue",
            "options": [
              "nosuid",
              "noexec",
              "nodev"
            ]
          },
          {
            "destination": "/dev/shm",
            "type": "tmpfs",
            "source": "shm",
            "options": [
              "nosuid",
              "noexec",
              "nodev",
              "mode=1777",
              "size=1073741824"
            ]
          },
          {
            "destination": "/persist",
            "type": "bind",
            "source": "/var/netapp/firetap/firegen/persist",
            "options": [
              "rbind",
              "rprivate"
            ]
          },
          {
            "destination": "/var/log",
            "type": "bind",
            "source": "/var/netapp/firetap/firegen/persist/var/log",
            "options": [
              "rbind",
              "rprivate"
            ]
          },
          {
            "destination": "/var/run/dbus",
            "type": "bind",
            "source": "/var/run/dbus",
            "options": [
              "rbind",
              "rprivate"
            ]
          }
        ],
        "linux": {
          "resources": {
            "devices": [
              {
                "allow": true,
                "access": "rwm"
              }
            ],
            "memory": {
              "disableOOMKiller": false
            },
            "cpu": {
              "shares": 0
            },
            "blockIO": {
              "weight": 0
            }
          },
          "cgroupsPath": "system.slice:runc:netwd",
          "namespaces": [
            {
              "type": "mount"
            },
            {
              "type": "uts"
            },
            {
              "type": "pid"
            },
            {
              "type": "ipc"
            }
          ],
          "devices": [
            {
              "path": "/dev/ipmi0",
              "type": "c",
              "major": 240,
              "minor": 0,
              "fileMode": 8576,
              "uid": 0,
              "gid": 0
            },
            {
              "path": "/dev/mem",
              "type": "c",
              "major": 1,
              "minor": 1,
              "fileMode": 8608,
              "uid": 0,
              "gid": 9
            }
          ]
        }
      }
  firegen.service: |
    [Unit]
    Description=firegen drive script
    Wants=network-online.target
    After=network-online.target
    Before=firetap.service
    [Service]
    Type=oneshot
    User=root
    WorkingDirectory=/opt/netapp/firetap
    RemainAfterExit=yes
    ExecStart=/usr/bin/bash /opt/netapp/firetap/fixupdevices.sh
    KillMode=mixed
    TimeoutStopSec=30
    [Install]
    WantedBy=multi-user.target
  firetap.service: |
    [Unit]
    Description=firetap
    Wants=network-online.target time-sync.target
    After=network-online.target time-sync.target
    [Service]
    Type=simple
    User=root
    WorkingDirectory=/opt/netapp/firetap
    Environment=CONTAINER_NAME=firetap
    RemainAfterExit=yes
    CPUAccounting=true
    MemoryAccounting=true
    ExecStartPre=/bin/bash /opt/netapp/firetap/firetapstart.sh
    ExecStart=/bin/env runc --systemd-cgroup start ${CONTAINER_NAME}
    ExecStop=/opt/netapp/firetap/stop.sh
    ExecStopPost=/bin/env runc delete -f ${CONTAINER_NAME}
    Restart=always
    KillMode=mixed
    TimeoutStopSec=30
    [Install]
    WantedBy=multi-user.target
  netwd.service: |
    [Unit]
    Description=netwd
    Wants=network-online.target time-sync.target
    After=network-online.target time-sync.target
    [Service]
    Type=simple
    User=root
    WorkingDirectory=/opt/netapp/firetap/netwd
    Environment=CONTAINER_NAME=netwd
    RemainAfterExit=yes
    ExecStartPre=/bin/bash /opt/netapp/firetap/netwd/netwdstart.sh
    ExecStart=/bin/env runc --systemd-cgroup start ${CONTAINER_NAME}
    ExecStop=/opt/netapp/firetap/stop.sh
    ExecStopPost=/bin/env runc delete -f ${CONTAINER_NAME}
    Restart=always
    KillMode=mixed
    TimeoutStopSec=30
    [Install]
    WantedBy=multi-user.target
kind: ConfigMap
metadata:
  labels:
    product: astrads
  name: astrads-firetap-cm
